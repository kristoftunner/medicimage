#include <wx/menu.h>
#include <wx/msgdlg.h>
#include <wx/log.h>
#include <wx/stattext.h>
#include <wx/textctrl.h>
#include <wx/sizer.h>
#include <wx/button.h>
#include <wx/splitter.h>

#include "frame.h"
#include "thumbnails/thumbnails.h"
#include "toolbox/toolbox.h"
#include "editor/canvas.h"
#include "editor/editor_events.h"
namespace app
{

enum
{
    ID_Hello = 1
};

MyFrame::MyFrame()
  : wxFrame(NULL, wxID_ANY, "Hello World")
{
  m_logger = new wxLogWindow(this, "Log", true, false);
  wxLog::SetActiveTarget(m_logger);

  
  wxMenu *menuFile = new wxMenu;
  menuFile->Append(ID_Hello, "&Hello...\tCtrl-H",
                   "Help string shown in status bar for this menu item");
  menuFile->AppendSeparator();
  menuFile->Append(wxID_EXIT);
  wxMenu *menuHelp = new wxMenu;
  menuHelp->Append(wxID_ABOUT);
  wxMenuBar *menuBar = new wxMenuBar;
  menuBar->Append(menuFile, "&File");
  menuBar->Append(menuHelp, "&Help");
  SetMenuBar( menuBar );
  
  bool isDark = wxSystemSettings::GetAppearance().IsDark();
  const auto margin = FromDIP(5);
  
  auto mainSplitter = new wxSplitterWindow(this, wxID_ANY, wxDefaultPosition, wxDefaultSize, wxSP_LIVE_UPDATE | wxSP_3DSASH);
  auto nestedSplitter = new wxSplitterWindow(mainSplitter, wxID_ANY, wxDefaultPosition, wxDefaultSize, wxSP_LIVE_UPDATE | wxSP_3DSASH);
  mainSplitter->SetSashSize(FromDIP(10));
  nestedSplitter->SetSashSize(FromDIP(10));

  auto toolbox = new Toolbox(nestedSplitter, wxID_ANY);
  toolbox->SetBackgroundColour(wxColour(isDark ? m_darkBackground : m_lightBackground));
  auto canvas = new Canvas(nestedSplitter, wxID_ANY);
  canvas->SetBackgroundColour(wxColour(isDark ? m_darkBackground : m_lightBackground));
  
  nestedSplitter->SplitVertically(toolbox, canvas, 200);
  nestedSplitter->SetMinimumPaneSize(200);
  nestedSplitter->SetDoubleBuffered(true);
  
  auto gridBagLayout = new Thumbnails(mainSplitter, wxID_ANY);
  gridBagLayout->SetBackgroundColour(wxColour(isDark ? m_darkBackground : m_lightBackground));
  
  mainSplitter->SplitVertically(nestedSplitter, gridBagLayout, 400);
  mainSplitter->SetMinimumPaneSize(200);
  mainSplitter->SetDoubleBuffered(true);

  wxBoxSizer *topsizer = new wxBoxSizer( wxHORIZONTAL );
  topsizer->Add(mainSplitter, 1, wxEXPAND );
  
  this->SetSizerAndFit(topsizer);
  Bind(wxEVT_MENU, &MyFrame::OnHello, this, ID_Hello);
  Bind(wxEVT_MENU, &MyFrame::OnAbout, this, wxID_ABOUT);
  Bind(wxEVT_MENU, &MyFrame::OnExit, this, wxID_EXIT);

  // Events generated by toolbox and relayed to canvas
  auto relayToolboxEvent = [this, canvas](wxCommandEvent &event){wxPostEvent(canvas, event);};
  Bind(TOOLBOX_SCREENSHOT, relayToolboxEvent);
  Bind(TOOLBOX_SAVE, relayToolboxEvent);
  Bind(TOOLBOX_DELETE, relayToolboxEvent);
  Bind(TOOLBOX_UNDO, relayToolboxEvent);

  Bind(TOOLBOX_DRAW_TEXT, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_LETTERS, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_ARROW, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_CIRCLE, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_LINE, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_MULTILINE, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_RECTANGLE, relayToolboxEvent);
  Bind(TOOLBOX_DRAW_SKIN_TEMPLATE, relayToolboxEvent);

  Bind(wxEVT_CHAR_HOOK, [this, canvas, toolbox](wxKeyEvent &event) {
    auto character  = event.GetUnicodeKey();
    wxPostEvent(canvas, event);});  
  
  // Events generated by canvas and relayed to thumbnails
  auto relayCanvasEvent = [this, gridBagLayout](ImageDocumentEvent &event){wxPostEvent(gridBagLayout, event);};
  Bind(EVT_EDITOR_DELETE_DOCUMENT, relayCanvasEvent);
  Bind(EVT_EDITOR_SAVE_DOCUMENT, relayCanvasEvent);
}
 
void MyFrame::OnExit(wxCommandEvent& event)
{
    Close(true);
}
 
void MyFrame::OnAbout(wxCommandEvent& event)
{
    wxMessageBox("This is a wxWidgets Hello World example",
                 "About Hello World", wxOK | wxICON_INFORMATION);
}
 
void MyFrame::OnHello(wxCommandEvent& event)
{
    wxLogMessage("Hello world from wxWidgets!");
}

}